<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SchoolQuest üéÆ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Poppins:wght@400;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #FF6B9D;
            --secondary: #4ECDC4;
            --accent: #FFC93C;
            --success: #06D6A0;
            --error: #FF6B8B;
            --dark: #2D3748;
            --light: #F7FAFC;
            --shadow: 0 10px 40px rgba(0,0,0,0.1);
            --radius-lg: 30px;
            --radius-md: 20px;
            --radius-sm: 15px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 10px;
            color: var(--dark);
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* ========== HEADER ========== */
        .header {
            background: white;
            border-radius: var(--radius-lg);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .logo {
            font-family: 'Fredoka', cursive;
            font-size: 48px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #718096;
            font-size: 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-logout {
            padding: 8px 16px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #FF6B8B, #FF8FA3);
            color: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255,107,139,0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f6f8fb, #ffffff);
            padding: 15px;
            border-radius: var(--radius-md);
            border: 2px solid #E2E8F0;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 13px;
            color: #718096;
            margin-top: 5px;
        }

        /* ========== PROGRESS BAR ========== */
        .progress-wrapper {
            background: rgba(255,255,255,0.3);
            height: 12px;
            border-radius: 20px;
            overflow: hidden;
            margin-top: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--secondary));
            border-radius: 20px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0%;
        }

        /* ========== CARDS ========== */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .card-title {
            font-family: 'Fredoka', cursive;
            font-size: 24px;
            color: var(--dark);
            margin-bottom: 20px;
            text-align: center;
        }

        /* ========== BUTTONS ========== */
        .btn {
            font-family: 'Fredoka', cursive;
            font-size: 18px;
            padding: 16px 32px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #FF8FB9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255,107,157,0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), #6FE3DB);
            color: white;
        }

        .btn-accent {
            background: linear-gradient(135deg, var(--accent), #FFD700);
            color: var(--dark);
        }

        .btn-full {
            width: 100%;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-group .btn {
            flex: 1;
        }

        /* ========== TABS ========== */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border-radius: var(--radius-md);
            border: 2px solid #E2E8F0;
            background: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            color: #718096;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary), #FF8FB9);
            color: white;
            border-color: var(--primary);
        }

        /* ========== UPLOAD AREA ========== */
        .upload-zone {
            border: 3px dashed var(--accent);
            border-radius: var(--radius-md);
            padding: 40px 20px;
            text-align: center;
            background: linear-gradient(135deg, #FFF9E6, #FFFBF0);
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, #FFF5E1, #FFF9E6);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 15px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .upload-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 14px;
            color: #718096;
        }

        /* ========== IMAGE PREVIEW ========== */
        .preview {
            position: relative;
            margin: 20px 0;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .preview img {
            width: 100%;
            border-radius: var(--radius-md);
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }

        /* ========== TEXT AREA ========== */
        .text-input {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #E2E8F0;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 16px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* ========== LOADING ========== */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border: 5px solid #E2E8F0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== GAME AREA ========== */
        .game {
            animation: slideUp 0.5s;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px dashed #E2E8F0;
        }

        .question-counter {
            background: var(--primary);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 15px;
        }

        .difficulty {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
        }

        .difficulty-f√°cil { background: #D1FAE5; color: #065F46; }
        .difficulty-m√©dio { background: #FEF3C7; color: #78350F; }
        .difficulty-dif√≠cil { background: #FEE2E2; color: #991B1B; }

        .question-box {
            background: linear-gradient(135deg, #F0F9FF, #E0F2FE);
            padding: 30px;
            border-radius: var(--radius-md);
            margin-bottom: 25px;
            border-left: 6px solid var(--secondary);
        }

        .question-text {
            font-size: 22px;
            font-weight: 600;
            color: var(--dark);
            line-height: 1.5;
        }

        /* ========== OPTIONS ========== */
        .options {
            display: grid;
            gap: 12px;
        }

        .option {
            padding: 20px;
            background: white;
            border: 3px solid #E2E8F0;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .option:hover {
            border-color: var(--primary);
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .option-letter {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), #FF8FB9);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
        }

        .option.correct {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .option.correct .option-letter {
            background: white;
            color: var(--success);
        }

        .option.wrong {
            background: var(--error);
            color: white;
            border-color: var(--error);
            animation: shake 0.5s;
        }

        .option.wrong .option-letter {
            background: white;
            color: var(--error);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* ========== COMPLETAR FRASE ========== */
        .fill-blank-container {
            background: linear-gradient(135deg, #FFF9E6, #FFFBF0);
            padding: 30px;
            border-radius: var(--radius-md);
            margin-bottom: 25px;
        }

        .sentence-with-blank {
            font-size: 20px;
            line-height: 1.8;
            color: var(--dark);
            margin-bottom: 20px;
        }

        .blank-space {
            display: inline-block;
            min-width: 150px;
            padding: 5px 15px;
            border-bottom: 3px dashed var(--primary);
            font-weight: 700;
            color: var(--primary);
            background: white;
            border-radius: 5px;
        }

        /* ========== JOGO DA MEM√ìRIA ========== */
        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .memory-card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, var(--primary), #FF8FB9);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            position: relative;
            color: white;
            font-weight: 600;
            padding: 10px;
            text-align: center;
        }

        .memory-card:hover:not(.matched) {
            transform: scale(1.05);
        }

        .memory-card.flipped {
            background: white;
            border: 3px solid var(--secondary);
            color: var(--dark);
        }

        .memory-card.matched {
            background: var(--success);
            color: white;
            cursor: default;
            opacity: 0.6;
        }

        /* ========== LIGAR PONTOS ========== */
        .connect-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin: 20px 0;
        }

        .connect-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .connect-item {
            padding: 15px;
            background: white;
            border: 3px solid #E2E8F0;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
            font-weight: 500;
            text-align: center;
        }

        .connect-item:hover:not(.matched) {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .connect-item.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .connect-item.matched {
            background: var(--success);
            color: white;
            border-color: var(--success);
            cursor: default;
        }

        /* ========== FEEDBACK ========== */
        .feedback {
            margin-top: 25px;
            padding: 25px;
            border-radius: var(--radius-md);
            animation: fadeIn 0.5s;
        }

        .feedback-correct {
            background: linear-gradient(135deg, var(--success), #00E4B4);
            color: white;
        }

        .feedback-wrong {
            background: linear-gradient(135deg, var(--error), #FF8FA3);
            color: white;
        }

        .feedback-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
        }

        .feedback-points {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .explanation {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: var(--radius-sm);
            margin-top: 15px;
            font-size: 15px;
            line-height: 1.6;
        }

        /* ========== FINAL SCREEN ========== */
        .final {
            text-align: center;
            padding: 40px 20px;
        }

        .final-trophy {
            font-size: 100px;
            margin-bottom: 20px;
            animation: bounce 1s infinite;
        }

        .final-score {
            font-size: 56px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 20px 0;
        }

        .final-message {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
            margin: 20px 0;
        }

        .final-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
        }

        .final-stat {
            text-align: center;
        }

        .final-stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary);
        }

        .final-stat-label {
            font-size: 14px;
            color: #718096;
        }

        /* ========== CACHE INFO ========== */
        .cache-info {
            background: linear-gradient(135deg, #E0F2FE, #DBEAFE);
            border: 2px solid var(--secondary);
            border-radius: var(--radius-md);
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .cache-icon {
            font-size: 32px;
        }

        .cache-text {
            flex: 1;
            font-size: 14px;
            color: var(--dark);
        }

        /* ========== GAME MODE SELECTOR ========== */
        .mode-selector {
            background: linear-gradient(135deg, #F3E8FF, #E9D5FF);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 20px;
        }

        .mode-title {
            font-family: 'Fredoka', cursive;
            font-size: 20px;
            color: var(--dark);
            margin-bottom: 15px;
            text-align: center;
        }

        .mode-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .mode-btn {
            padding: 15px;
            background: white;
            border: 3px solid #E2E8F0;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .mode-btn:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .mode-icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .mode-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
        }

        /* ========== ERROR MESSAGE ========== */
        .error-message {
            background: linear-gradient(135deg, var(--error), #FF8FA3);
            color: white;
            padding: 20px;
            border-radius: var(--radius-md);
            margin: 20px 0;
            text-align: center;
        }

        .error-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        /* ========== CONNECTION STATUS ========== */
        .connection-status {
            background: #FFF5F5;
            border: 2px solid var(--error);
            border-radius: var(--radius-md);
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .connection-status.active {
            display: block;
        }

        .connection-status.connected {
            background: #F0FFF4;
            border-color: var(--success);
        }

        /* ========== UTILITY ========== */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mb-20 { margin-bottom: 20px; }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 600px) {
            .logo { font-size: 36px; }
            .card { padding: 20px; }
            .question-text { font-size: 18px; }
            .option { padding: 15px; }
            .btn-group { flex-direction: column; }
            .final-stats { flex-direction: column; gap: 15px; }
            .memory-grid { grid-template-columns: repeat(3, 1fr); }
            .connect-container { grid-template-columns: 1fr; gap: 20px; }
            .mode-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- CONNECTION STATUS -->
        <div class="connection-status" id="connectionStatus">
            <div style="font-weight: 600; margin-bottom: 5px;">‚ö†Ô∏è Status da Conex√£o</div>
            <div id="connectionMessage">Verificando conex√£o com o servidor...</div>
        </div>

        <!-- HEADER -->
        <header class="header">
            <div class="logo">üéÆ SchoolQuest</div>
            <div class="subtitle" id="subtitleArea">
                Aprender brincando √© mais divertido!
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="points">0</div>
                    <div class="stat-label">Pontos üéØ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stars">‚≠ê‚≠ê‚≠ê</div>
                    <div class="stat-label">Estrelas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="level">1</div>
                    <div class="stat-label">N√≠vel üèÜ</div>
                </div>
            </div>

            <div class="progress-wrapper">
                <div class="progress-fill" id="progress"></div>
            </div>
        </header>

        <!-- CACHE INFO -->
        <div class="cache-info hidden" id="cacheInfo">
            <div class="cache-icon">üíæ</div>
            <div class="cache-text">
                <strong>Quiz salvo!</strong> Escolha um modo diferente para jogar.
            </div>
        </div>

        <!-- UPLOAD CARD -->
        <div class="card" id="uploadCard">
            <h2 class="card-title">
                Pronto para o desafio? üëã
            </h2>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('image')">
                    üì∑ Foto
                </button>
                <button class="tab-btn" onclick="switchTab('text')">
                    ‚úèÔ∏è Texto
                </button>
            </div>

            <!-- IMAGE TAB -->
            <div id="imageTab">
                <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üì∏</div>
                    <div class="upload-text">Tire uma foto do dever de casa</div>
                    <div class="upload-hint">Ou arraste a imagem aqui</div>
                </div>
                <input type="file" id="fileInput" accept="image/*" capture="environment" class="hidden">

                <div id="preview" class="hidden preview">
                    <img id="previewImg" alt="Preview">
                    <button class="btn btn-primary btn-full" onclick="processImage()" style="margin-top: 20px;">
                        üöÄ Come√ßar o Jogo!
                    </button>
                </div>
            </div>

            <!-- TEXT TAB -->
            <div id="textTab" class="hidden">
                <textarea 
                    id="textInput" 
                    class="text-input" 
                    placeholder="Cole ou digite o texto do dever de casa aqui... üìù"></textarea>
                <button class="btn btn-primary btn-full" onclick="processText()" style="margin-top: 20px;">
                    üéØ Criar Quiz!
                </button>
            </div>
        </div>

        <!-- LOADING -->
        <div class="card hidden" id="loading">
            <div class="loading">
                <div class="spinner"></div>
                <div style="font-size: 20px; font-weight: 600; color: var(--primary); margin-bottom: 10px;">
                    Preparando o jogo...
                </div>
                <div style="font-size: 15px; color: #718096;">
                    Analisando o conte√∫do com IA... ‚ú®
                </div>
            </div>
        </div>

        <!-- GAME AREA -->
        <div id="gameArea"></div>
    </div>

    <script>
        // ========== CONFIGURA√á√ÉO DA API - AUTO-DETEC√á√ÉO ========== (function() {
            const hostname = window.location.hostname;
            
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:8000';
            }
            
            return 'https://schoolquest-aukm.onrender.com';
        })();

        console.log('üåê API configurada para:', API_BASE_URL);

        // ========== AUTENTICA√á√ÉO ========== (const token = localStorage.getItem('token');
        const username = localStorage.getItem('username');

        // Redirecionar para login se n√£o autenticado
        if (!token) {
            console.warn('‚ö†Ô∏è Token n√£o encontrado. Redirecionando para login...');
            window.location.href = '/login.html';
        }

        // Exibir username e bot√£o de logout
        if (username) {
            const subtitleArea = document.getElementById('subtitleArea');
            subtitleArea.innerHTML = `
                <span>Bem-vindo, <strong>${username}</strong>! üéâ</span>
                <button class="btn-logout" onclick="logout()">üö™ Sair</button>
            `;
        }

        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                console.log('üëã Logout realizado');
                window.location.href = '/login.html';
            }
        }

        // ========== FETCH COM TIMEOUT ========== async function fetchWithTimeout(url, options = {}, timeout = 30000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('Tempo esgotado. O servidor pode estar reiniciando.');
                }
                throw error;
            }
        }

        // ========== CHAMADAS DE API COM TOKEN JWT ========== async function callProcessImage(file) {
            const token = localStorage.getItem('token');
            
            if (!token) {
                throw new Error('Token n√£o encontrado. Fa√ßa login novamente.');
            }

            const formData = new FormData();
            formData.append('file', file);

            console.log('üì§ Enviando imagem com autentica√ß√£o...');

            const response = await fetchWithTimeout(`${API_BASE_URL}/api/process-image`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            }, 60000);

            if (response.status === 401) {
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                alert('Sess√£o expirada. Fa√ßa login novamente.');
                window.location.href = '/login.html';
                throw new Error('Sess√£o expirada');
            }

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.detail || `Erro ${response.status}`);
            }

            return await response.json();
        }

        async function callProcessText(text) {
            const token = localStorage.getItem('token');

            console.log('üì§ Enviando texto...');

            const response = await fetchWithTimeout(`${API_BASE_URL}/api/process-text`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                },
                body: JSON.stringify({ text })
            }, 60000);

            if (response.status === 401 && token) {
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                alert('Sess√£o expirada. Fa√ßa login novamente.');
                window.location.href = '/login.html';
                throw new Error('Sess√£o expirada');
            }

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.detail || `Erro ${response.status}`);
            }

            return await response.json();
        }

        // ========== CONNECTION CHECK ========== async function checkConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            const messageDiv = document.getElementById('connectionMessage');
            
            try {
                console.log('üîç Verificando conex√£o...');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(`${API_BASE_URL}/api/health`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Backend conectado:', data);
                    
                    statusDiv.classList.add('connected');
                    messageDiv.innerHTML = `‚úÖ Conectado! (${data.ai_provider.toUpperCase()})`;
                    
                    setTimeout(() => {
                        statusDiv.classList.remove('active');
                    }, 3000);
                } else {
                    throw new Error(`Servidor retornou: ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå Erro de conex√£o:', error);
                
                statusDiv.classList.add('active');
                messageDiv.innerHTML = `‚ö†Ô∏è N√£o foi poss√≠vel conectar ao servidor.`;
            }
        }

        // ========== GAME MODES ========== (const GAME_MODES = {
            MULTIPLE_CHOICE: 'multiple_choice',
            FILL_BLANK: 'fill_blank',
            MEMORY: 'memory',
            CONNECT: 'connect'
        };

        // ========== STATE ========== let state = {
            questions: [],
            originalQuestions: [],
            currentIndex: 0,
            points: 0,
            stars: 3,
            level: 1,
            uploadedFile: null,
            isFromCache: false,
            currentMode: GAME_MODES.MULTIPLE_CHOICE,
            memoryFlipped: [],
            memoryMatched: [],
            memoryCards: [],
            connectSelected: null,
            connectMatches: [],
            connectPairs: []
        };

        // ========== CONVERTERS ========== const questionConverters = {
            toMultipleChoice: (q) => q,
            
            toFillBlank: (q) => {
                const correctAnswer = q.options[q.correct];
                const sentence = q.question.replace('?', '').replace('üß†', '').trim();
                return {
                    ...q,
                    sentence: sentence,
                    blank: correctAnswer,
                    options: [...q.options].sort(() => Math.random() - 0.5)
                };
            },
            
            toMemory: (questions) => {
                const pairs = questions.slice(0, 6).map(q => ({
                    question: q.question.replace('üß†', '').substring(0, 40) + '...',
                    answer: q.options[q.correct],
                    explanation: q.explanation
                }));
                
                const cards = [];
                pairs.forEach((pair, i) => {
                    cards.push({ id: i * 2, type: 'question', text: pair.question, pairId: i, ...pair });
                    cards.push({ id: i * 2 + 1, type: 'answer', text: pair.answer, pairId: i, ...pair });
                });
                
                return cards.sort(() => Math.random() - 0.5);
            },
            
            toConnect: (questions) => {
                const pairs = questions.slice(0, 5).map((q, i) => ({
                    id: i,
                    question: q.question.replace('üß†', '').trim(),
                    answer: q.options[q.correct],
                    explanation: q.explanation,
                    points: q.points
                }));
                return pairs.sort(() => Math.random() - 0.5);
            }
        };

        // ========== TEMPLATES ========== const templates = {
            modeSelector: () => `
                <div class="card">
                    <div class="mode-selector">
                        <div class="mode-title">üéØ Escolha o Modo de Jogo</div>
                        <div class="mode-grid">
                            <div class="mode-btn" onclick="selectMode('${GAME_MODES.MULTIPLE_CHOICE}')">
                                <div class="mode-icon">‚úÖ</div>
                                <div class="mode-label">M√∫ltipla Escolha</div>
                            </div>
                            <div class="mode-btn" onclick="selectMode('${GAME_MODES.FILL_BLANK}')">
                                <div class="mode-icon">‚úèÔ∏è</div>
                                <div class="mode-label">Completar Frase</div>
                            </div>
                            <div class="mode-btn" onclick="selectMode('${GAME_MODES.MEMORY}')">
                                <div class="mode-icon">üß†</div>
                                <div class="mode-label">Jogo da Mem√≥ria</div>
                            </div>
                            <div class="mode-btn" onclick="selectMode('${GAME_MODES.CONNECT}')">
                                <div class="mode-icon">üîó</div>
                                <div class="mode-label">Ligar Pontos</div>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            multipleChoice: (q, index, total) => `
                <div class="card game">
                    <div class="question-header">
                        <div class="question-counter">Quest√£o ${index + 1}/${total}</div>
                        <div class="difficulty difficulty-${q.difficulty}">${q.difficulty}</div>
                    </div>

                    <div class="question-box">
                        <div class="question-text">${q.question}</div>
                    </div>

                    <div class="options">
                        ${q.options.map((opt, i) => `
                            <div class="option" onclick="selectAnswer(${i})">
                                <div class="option-letter">${String.fromCharCode(65 + i)}</div>
                                <div>${opt}</div>
                            </div>
                        `).join('')}
                    </div>

                    <div id="feedback"></div>
                </div>
            `,

            fillBlank: (q, index, total) => `
                <div class="card game">
                    <div class="question-header">
                        <div class="question-counter">Quest√£o ${index + 1}/${total}</div>
                        <div class="difficulty difficulty-${q.difficulty}">${q.difficulty}</div>
                    </div>

                    <div class="fill-blank-container">
                        <div class="sentence-with-blank">
                            ${q.sentence} <span class="blank-space" id="blankSpace">___________</span>
                        </div>
                        <div style="text-align: center; color: #718096; font-size: 14px; margin-top: 10px;">
                            Complete a frase escolhendo a palavra correta abaixo ‚úèÔ∏è
                        </div>
                    </div>

                    <div class="options">
                        ${q.options.map((opt, i) => `
                            <div class="option" onclick="selectFillBlank(${i}, '${opt.replace(/'/g, "\'")}')">
                                <div class="option-letter">${String.fromCharCode(65 + i)}</div>
                                <div>${opt}</div>
                            </div>
                        `).join('')}
                    </div>

                    <div id="feedback"></div>
                </div>
            `,

            memory: (cards) => `
                <div class="card game">
                    <div class="card-title">üß† Jogo da Mem√≥ria</div>
                    <div style="text-align: center; color: #718096; margin-bottom: 20px;">
                        Encontre os pares de perguntas e respostas!
                    </div>

                    <div class="memory-grid" id="memoryGrid">
                        ${cards.map((card, i) => `
                            <div class="memory-card" data-id="${i}" data-pair="${card.pairId}" onclick="flipCard(${i})">
                                ‚ùì
                            </div>
                        `).join('')}
                    </div>

                    <div id="feedback"></div>

                    <div class="btn-group">
                        <button class="btn btn-accent" onclick="resetMemory()">
                            üîÑ Reiniciar
                        </button>
                        <button class="btn btn-secondary" onclick="showFinalScreen()">
                            ‚úÖ Finalizar
                        </button>
                    </div>
                </div>
            `,

            connect: (pairs) => `
                <div class="card game">
                    <div class="card-title">üîó Ligar Pontos</div>
                    <div style="text-align: center; color: #718096; margin-bottom: 20px;">
                        Clique em uma pergunta e depois na resposta correspondente!
                    </div>

                    <div class="connect-container">
                        <div class="connect-column">
                            ${pairs.map((p, i) => `
                                <div class="connect-item" data-type="question" data-id="${i}" onclick="selectConnect('question', ${i})">
                                    ${p.question}
                                </div>
                            `).join('')}
                        </div>
                        <div class="connect-column">
                            ${pairs.map((p, i) => {
                                const shuffledIndex = Math.floor(Math.random() * 1000);
                                return `
                                    <div class="connect-item" data-type="answer" data-id="${i}" data-shuffle="${shuffledIndex}" onclick="selectConnect('answer', ${i})">
                                        ${p.answer}
                                    </div>
                                `;
                            }).sort((a, b) => {
                                const aNum = parseInt(a.match(/data-shuffle="(\d+)"/)[1]);
                                const bNum = parseInt(b.match(/data-shuffle="(\d+)"/)[1]);
                                return aNum - bNum;
                            }).join('')}
                        </div>
                    </div>

                    <div id="feedback"></div>

                    <div class="btn-group">
                        <button class="btn btn-accent" onclick="resetConnect()">
                            üîÑ Reiniciar
                        </button>
                        <button class="btn btn-secondary" onclick="showFinalScreen()">
                            ‚úÖ Finalizar
                        </button>
                    </div>
                </div>
            `,

            feedback: (correct, points, explanation) => `
                <div class="feedback feedback-${correct ? 'correct' : 'wrong'}">
                    <div class="feedback-title">${correct ? 'üéâ Parab√©ns!' : '‚ùå Ops!'}</div>
                    <div class="feedback-points">
                        ${correct ? `+${points} pontos` : 'Tente novamente!'}
                    </div>
                    ${explanation ? `<div class="explanation">üí° ${explanation}</div>` : ''}
                    <button class="btn btn-primary btn-full" onclick="nextQuestion()" style="margin-top: 20px;">
                        Pr√≥xima Pergunta &rarr;
                    </button>
                </div>
            `,

            error: (message) => `
                <div class="card">
                    <div class="error-message">
                        <div class="error-title">‚ö†Ô∏è Erro</div>
                        <div>${message}</div>
                    </div>
                    <button class="btn btn-primary btn-full" onclick="location.reload()">
                        üîÑ Tentar Novamente
                    </button>
                </div>
            `
        };

        // ========== TAB SWITCHING ========== function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (tab === 'image') {
                document.getElementById('imageTab').classList.remove('hidden');
                document.getElementById('textTab').classList.add('hidden');
            } else {
                document.getElementById('imageTab').classList.add('hidden');
                document.getElementById('textTab').classList.remove('hidden');
            }
        }

        // ========== FILE HANDLING ========== const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--primary)';
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.style.borderColor = 'var(--accent)';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--accent)';
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) handleFile(file);
        });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('preview').classList.remove('hidden');
                state.uploadedFile = file;
            };
            reader.readAsDataURL(file);
        }

        // ========== PROCESSING ========== async function processImage() {
            if (!state.uploadedFile) return;
            
            showLoading();
            
            try {
                console.log('üöÄ Enviando imagem...');
                const data = await callProcessImage(state.uploadedFile);
                console.log('‚úÖ Quest√µes recebidas:', data);
                
                state.originalQuestions = data.questions;
                state.questions = data.questions;
                hideLoading();
                showModeSelector();
            } catch (error) {
                console.error('‚ùå Erro:', error);
                hideLoading();
                document.getElementById('gameArea').innerHTML = templates.error(error.message);
            }
        }

        async function processText() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                alert('Por favor, insira algum texto!');
                return;
            }
            
            showLoading();
            
            try {
                console.log('üöÄ Enviando texto...');
                const data = await callProcessText(text);
                console.log('‚úÖ Quest√µes recebidas:', data);
                
                state.originalQuestions = data.questions;
                state.questions = data.questions;
                hideLoading();
                showModeSelector();
            } catch (error) {
                console.error('‚ùå Erro:', error);
                hideLoading();
                document.getElementById('gameArea').innerHTML = templates.error(error.message);
            }
        }

        // ========== MODE SELECTION ========== function showModeSelector() {
            document.getElementById('uploadCard').classList.add('hidden');
            document.getElementById('cacheInfo').classList.remove('hidden');
            
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = templates.modeSelector();
        }

        function selectMode(mode) {
            state.currentMode = mode;
            state.currentIndex = 0;
            state.memoryFlipped = [];
            state.memoryMatched = [];
            state.connectSelected = null;
            state.connectMatches = [];
            
            renderGame();
        }

        // ========== GAME RENDERING ========== function renderGame() {
            const gameArea = document.getElementById('gameArea');
            
            switch(state.currentMode) {
                case GAME_MODES.MULTIPLE_CHOICE:
                    if (state.currentIndex < state.questions.length) {
                        const q = questionConverters.toMultipleChoice(state.questions[state.currentIndex]);
                        gameArea.innerHTML = templates.multipleChoice(q, state.currentIndex, state.questions.length);
                    } else {
                        showFinalScreen();
                    }
                    break;
                    
                case GAME_MODES.FILL_BLANK:
                    if (state.currentIndex < state.questions.length) {
                        const q = questionConverters.toFillBlank(state.questions[state.currentIndex]);
                        state.currentFillBlank = q;
                        gameArea.innerHTML = templates.fillBlank(q, state.currentIndex, state.questions.length);
                    } else {
                        showFinalScreen();
                    }
                    break;
                    
                case GAME_MODES.MEMORY:
                    const cards = questionConverters.toMemory(state.questions);
                    state.memoryCards = cards;
                    gameArea.innerHTML = templates.memory(cards);
                    break;
                    
                case GAME_MODES.CONNECT:
                    const pairs = questionConverters.toConnect(state.questions);
                    state.connectPairs = pairs;
                    gameArea.innerHTML = templates.connect(pairs);
                    break;
            }
            
            updateProgress();
        }

        // ========== MULTIPLE CHOICE ========== function selectAnswer(index) {
            const q = state.questions[state.currentIndex];
            const correct = index === q.correct;
            
            const options = document.querySelectorAll('.option');
            options.forEach(opt => opt.style.pointerEvents = 'none');
            
            if (correct) {
                options[index].classList.add('correct');
                state.points += q.points;
                updateStats();
            } else {
                options[index].classList.add('wrong');
                options[q.correct].classList.add('correct');
                state.stars = Math.max(1, state.stars - 1);
                updateStats();
            }
            
            document.getElementById('feedback').innerHTML = templates.feedback(correct, q.points, q.explanation);
        }

        // ========== FILL BLANK ========== function selectFillBlank(index, selectedText) {
            const q = state.currentFillBlank;
            const correct = q.options[index] === q.blank;
            
            const options = document.querySelectorAll('.option');
            options.forEach(opt => opt.style.pointerEvents = 'none');
            
            const blankSpace = document.getElementById('blankSpace');
            blankSpace.textContent = selectedText;
            
            if (correct) {
                options[index].classList.add('correct');
                blankSpace.style.color = 'var(--success)';
                blankSpace.style.borderColor = 'var(--success)';
                state.points += state.questions[state.currentIndex].points;
                updateStats();
            } else {
                options[index].classList.add('wrong');
                blankSpace.style.color = 'var(--error)';
                blankSpace.style.borderColor = 'var(--error)';
                
                const correctIndex = q.options.indexOf(q.blank);
                if (correctIndex !== -1) {
                    options[correctIndex].classList.add('correct');
                }
                state.stars = Math.max(1, state.stars - 1);
                updateStats();
            }
            
            document.getElementById('feedback').innerHTML = templates.feedback(correct, state.questions[state.currentIndex].points, state.questions[state.currentIndex].explanation);
        }

        function nextQuestion() {
            state.currentIndex++;
            renderGame();
        }

        // ========== MEMORY GAME ========== function flipCard(index) {
            const card = document.querySelector(`[data-id="${index}"]`);
            
            if (state.memoryMatched.includes(index) || state.memoryFlipped.includes(index) || state.memoryFlipped.length >= 2) {
                return;
            }
            
            const cardData = state.memoryCards[index];
            card.classList.add('flipped');
            card.textContent = cardData.text;
            state.memoryFlipped.push(index);
            
            if (state.memoryFlipped.length === 2) {
                setTimeout(() => checkMemoryMatch(), 500);
            }
        }

        function checkMemoryMatch() {
            const [first, second] = state.memoryFlipped;
            const card1 = state.memoryCards[first];
            const card2 = state.memoryCards[second];
            
            if (card1.pairId === card2.pairId) {
                const elem1 = document.querySelector(`[data-id="${first}"]`);
                const elem2 = document.querySelector(`[data-id="${second}"]`);
                elem1.classList.add('matched');
                elem2.classList.add('matched');
                state.memoryMatched.push(first, second);
                state.memoryFlipped = [];
                
                state.points += 20;
                updateStats();
                
                document.getElementById('feedback').innerHTML = templates.feedback(true, 20, card1.explanation);
                
                if (state.memoryMatched.length === state.memoryCards.length) {
                    setTimeout(() => showFinalScreen(), 2000);
                }
            } else {
                setTimeout(() => {
                    const elem1 = document.querySelector(`[data-id="${first}"]`);
                    const elem2 = document.querySelector(`[data-id="${second}"]`);
                    elem1.classList.remove('flipped');
                    elem2.classList.remove('flipped');
                    elem1.textContent = '‚ùì';
                    elem2.textContent = '‚ùì';
                    state.memoryFlipped = [];
                }, 1000);
            }
        }

        function resetMemory() {
            state.memoryFlipped = [];
            state.memoryMatched = [];
            state.points = 0;
            updateStats();
            renderGame();
        }

        // ========== CONNECT GAME ========== function selectConnect(type, id) {
            const element = document.querySelector(`[data-type="${type}"][data-id="${id}"]`);
            
            if (element.classList.contains('matched')) return;
            
            if (!state.connectSelected) {
                state.connectSelected = { type, id, element };
                element.classList.add('selected');
            } else {
                if (state.connectSelected.type === type) {
                    state.connectSelected.element.classList.remove('selected');
                    state.connectSelected = { type, id, element };
                    element.classList.add('selected');
                } else {
                    const questionId = type === 'question' ? id : state.connectSelected.id;
                    const answerId = type === 'answer' ? id : state.connectSelected.id;
                    
                    if (questionId === answerId) {
                        element.classList.add('matched');
                        element.classList.remove('selected');
                        state.connectSelected.element.classList.add('matched');
                        state.connectSelected.element.classList.remove('selected');
                        state.connectMatches.push({ questionId, answerId });
                        
                        state.points += state.connectPairs[questionId].points;
                        updateStats();
                        
                        document.getElementById('feedback').innerHTML = templates.feedback(true, state.connectPairs[questionId].points, state.connectPairs[questionId].explanation);
                        
                        state.connectSelected = null;
                        
                        if (state.connectMatches.length === state.connectPairs.length) {
                            setTimeout(() => showFinalScreen(), 2000);
                        }
                    } else {
                        element.classList.add('wrong');
                        state.connectSelected.element.classList.add('wrong');
                        
                        setTimeout(() => {
                            element.classList.remove('wrong', 'selected');
                            state.connectSelected.element.classList.remove('wrong', 'selected');
                            state.connectSelected = null;
                        }, 1000);
                        
                        state.stars = Math.max(1, state.stars - 1);
                        updateStats();
                    }
                }
            }
        }

        function resetConnect() {
            state.connectSelected = null;
            state.connectMatches = [];
            state.points = 0;
            updateStats();
            renderGame();
        }

        // ========== STATS & PROGRESS ========== function updateStats() {
            document.getElementById('points').textContent = state.points;
            document.getElementById('stars').textContent = '‚≠ê'.repeat(state.stars);
            document.getElementById('level').textContent = state.level;
        }

        function updateProgress() {
            let progress = 0;
            
            if (state.currentMode === GAME_MODES.MULTIPLE_CHOICE || state.currentMode === GAME_MODES.FILL_BLANK) {
                progress = (state.currentIndex / state.questions.length) * 100;
            } else if (state.currentMode === GAME_MODES.MEMORY) {
                progress = (state.memoryMatched.length / state.memoryCards.length) * 100;
            } else if (state.currentMode === GAME_MODES.CONNECT) {
                progress = (state.connectMatches.length / state.connectPairs.length) * 100;
            }
            
            document.getElementById('progress').style.width = progress + '%';
        }

        // ========== FINAL SCREEN ========== function showFinalScreen() {
            const gameArea = document.getElementById('gameArea');
            const totalQuestions = state.questions.length;
            
            let trophy = 'üèÜ';
            let message = 'Voc√™ √© incr√≠vel!';
            
            if (state.points >= totalQuestions * 15) {
                trophy = 'ü•á';
                message = 'Perfeito! Voc√™ √© um g√™nio!';
            } else if (state.points >= totalQuestions * 10) {
                trophy = 'ü•à';
                message = 'Muito bem! Continue assim!';
            } else if (state.points >= totalQuestions * 5) {
                trophy = 'ü•â';
                message = 'Bom trabalho! Pratique mais!';
            }
            
            gameArea.innerHTML = `
                <div class="card final">
                    <div class="final-trophy">${trophy}</div>
                    <div class="final-message">${message}</div>
                    <div class="final-score">${state.points}</div>
                    <div style="color: #718096; margin-bottom: 30px;">pontos conquistados!</div>
                    
                    <div class="final-stats">
                        <div class="final-stat">
                            <div class="final-stat-value">${totalQuestions}</div>
                            <div class="final-stat-label">Quest√µes</div>
                        </div>
                        <div class="final-stat">
                            <div class="final-stat-value">${state.stars}</div>
                            <div class="final-stat-label">Estrelas</div>
                        </div>
                        <div class="final-stat">
                            <div class="final-stat-value">${state.level}</div>
                            <div class="final-stat-label">N√≠vel</div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="location.reload()">
                            üè† In√≠cio
                        </button>
                        <button class="btn btn-accent" onclick="restartWithNewMode()">
                            üîÑ Novo Modo
                        </button>
                    </div>
                </div>
            `;
        }

        function restartWithNewMode() {
            state.currentIndex = 0;
            state.points = 0;
            state.stars = 3;
            updateStats();
            showModeSelector();
        }

        // ========== LOADING ========== function showLoading() {
            document.getElementById('uploadCard').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        // ========== INIT ========== updateStats();
        checkConnection();
    </script>
</body>
</html>